
defaults: &defaults
  environment:
    - DEPENDENCIES_BASE_URL: "https://raw.githubusercontent.com/wireapp/wire-ios-shared-resources/circle2"
  macos:
    xcode: "9.0.1"
  shell: /bin/bash --login -eo pipefail

# ----------------CACHING----------------

# Gems
gems_cache: &gems_cache
  key: v4-{{ checksum "Gemfile.lock" }}
  paths: ~/.gem

# Carthage
carthage_cache: &carthage_cache
  key: v2-{{ checksum "Cartfile.resolved" }}
  paths: Carthage/Build

# DerivedData
buildfiles_cache: &buildfiles_cache
  key: v2-{{ .Revision }}
  paths: DerivedData

# ------------Environment-----------------
download_environment: &download_environment
  name: "Download environment"
  command: |
    mkdir build_scripts
    cd build_scripts
    curl -O "${DEPENDENCIES_BASE_URL}/environment.sh"

setup_environment: &setup_environment
  name: "Setup environment"
  command: |
    bash build_scripts/environment.sh

version: 2
jobs:
      
  build:
    <<: *defaults
    steps:
    - checkout
    - run: *download_environment
    - run: *setup_environment
    - restore_cache: *gems_cache
    - restore_cache: *carthage_cache
    - run: 
        name: "Get dependencies"
        command: bash dependencies.sh
    - run: 
        name: "Build"
        command: bash build.sh
    - save_cache: *gems_cache
    - save_cache: *carthage_cache
    - persist_to_workspace:
        root: .
        paths: 
          - DerivedData/Build/Products/*
          - build_scripts
    - store_artifacts:
        path: xcode_build.log
    - store_artifacts:
        path: build_scripts


  test:
    <<: *defaults
    steps:
    - checkout
    - attach_workspace:
        at: .
    - run: *setup_environment
    - restore_cache: *gems_cache
    - restore_cache: *carthage_cache
    - run: 
        name: "Test"
        command: bash test.sh
    - run: 
        name: "Post test"
        command: bash post_test.sh
    - store_artifacts:
        path: xcode_test.log
    - store_artifacts:
        path: build_scripts
    - store_artifacts:
        path: SnapshotResults
    - store_test_results:
        path: junit


# ----------------WORKFLOWS----------------
workflows:
  version: 2
  build-and-test:
    jobs:
      - build
      - test:
          requires:
            - build
